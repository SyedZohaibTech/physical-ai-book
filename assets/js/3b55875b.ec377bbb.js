"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[68],{7428(e,r,n){n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"module1/python-rclpy","title":"Python Integration with rclpy","description":"The rclpy library is the Python client library for ROS 2, providing the Python API to interact with ROS 2 concepts like nodes, topics, services, parameters, and actions.","source":"@site/docs/module1/python-rclpy.md","sourceDirName":"module1","slug":"/module1/python-rclpy","permalink":"/physical-ai-book/docs/module1/python-rclpy","draft":false,"unlisted":false,"editUrl":"https://github.com/SyedZohaibTech/physical-ai-book/edit/main/docs/module1/python-rclpy.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Python Integration with rclpy"},"sidebar":"tutorialSidebar","previous":{"title":"Nodes, Topics, and Services","permalink":"/physical-ai-book/docs/module1/nodes-topics-services"},"next":{"title":"URDF for Humanoid Robots","permalink":"/physical-ai-book/docs/module1/urdf-humanoids"}}');var i=n(4848),t=n(8453);const l={sidebar_position:4,title:"Python Integration with rclpy"},o="Python Integration with rclpy",a={},c=[{value:"Publisher Example",id:"publisher-example",level:2},{value:"Subscriber Example",id:"subscriber-example",level:2},{value:"Service Client/Server Implementation",id:"service-clientserver-implementation",level:2},{value:"Service Server",id:"service-server",level:3},{value:"Service Client",id:"service-client",level:3},{value:"Parameters",id:"parameters",level:2},{value:"Advanced rclpy Concepts",id:"advanced-rclpy-concepts",level:2},{value:"Timers",id:"timers",level:3},{value:"Clock and Time",id:"clock-and-time",level:3},{value:"Waitables",id:"waitables",level:3},{value:"Lifecycle Nodes",id:"lifecycle-nodes",level:2},{value:"Message and Service Customization",id:"message-and-service-customization",level:2},{value:"Creating Custom Messages",id:"creating-custom-messages",level:3},{value:"Custom Services",id:"custom-services",level:3},{value:"Threading and Concurrency",id:"threading-and-concurrency",level:2},{value:"Single-threaded Executor",id:"single-threaded-executor",level:3},{value:"Multi-threaded Executor",id:"multi-threaded-executor",level:3},{value:"Error Handling and Best Practices",id:"error-handling-and-best-practices",level:2},{value:"Exception Handling",id:"exception-handling",level:3},{value:"Resource Management",id:"resource-management",level:3},{value:"Python-Specific Considerations",id:"python-specific-considerations",level:2},{value:"Memory Management",id:"memory-management",level:3},{value:"Type Hints for Better Code",id:"type-hints-for-better-code",level:3}];function d(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"python-integration-with-rclpy",children:"Python Integration with rclpy"})}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"rclpy"})," library is the Python client library for ROS 2, providing the Python API to interact with ROS 2 concepts like nodes, topics, services, parameters, and actions."]}),"\n",(0,i.jsx)(r.h2,{id:"publisher-example",children:"Publisher Example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom std_msgs.msg import String\r\n\r\nclass MinimalPublisher(Node):\r\n    def __init__(self):\r\n        super().__init__('minimal_publisher')\r\n        self.publisher_ = self.create_publisher(String, 'topic', 10)\r\n        self.timer = self.create_timer(0.5, self.timer_callback)\r\n        self.i = 0\r\n\r\n    def timer_callback(self):\r\n        msg = String()\r\n        msg.data = f'Hello World: {self.i}'\r\n        self.publisher_.publish(msg)\r\n        self.get_logger().info(f'Publishing: \"{msg.data}\"')\r\n        self.i += 1\n"})}),"\n",(0,i.jsx)(r.h2,{id:"subscriber-example",children:"Subscriber Example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom std_msgs.msg import String\r\n\r\nclass MinimalSubscriber(Node):\r\n    def __init__(self):\r\n        super().__init__('minimal_subscriber')\r\n        self.subscription = self.create_subscription(\r\n            String,\r\n            'topic',\r\n            self.listener_callback,\r\n            10)\r\n        self.subscription  # prevent unused variable warning\r\n\r\n    def listener_callback(self, msg):\r\n        self.get_logger().info(f'I heard: \"{msg.data}\"')\n"})}),"\n",(0,i.jsx)(r.h2,{id:"service-clientserver-implementation",children:"Service Client/Server Implementation"}),"\n",(0,i.jsx)(r.h3,{id:"service-server",children:"Service Server"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom example_interfaces.srv import AddTwoInts\r\n\r\nclass MinimalService(Node):\r\n    def __init__(self):\r\n        super().__init__('minimal_service')\r\n        self.srv = self.create_service(AddTwoInts, 'add_two_ints', self.add_two_ints_callback)\r\n\r\n    def add_two_ints_callback(self, request, response):\r\n        response.sum = request.a + request.b\r\n        self.get_logger().info(f'Incoming request\\na: {request.a}, b: {request.b}')\r\n        return response\n"})}),"\n",(0,i.jsx)(r.h3,{id:"service-client",children:"Service Client"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom example_interfaces.srv import AddTwoInts\r\n\r\nclass MinimalClient(Node):\r\n    def __init__(self):\r\n        super().__init__('minimal_client')\r\n        self.cli = self.create_client(AddTwoInts, 'add_two_ints')\r\n        while not self.cli.wait_for_service(timeout_sec=1.0):\r\n            self.get_logger().info('Service not available, waiting again...')\r\n        self.req = AddTwoInts.Request()\r\n\r\n    def send_request(self, a, b):\r\n        self.req.a = a\r\n        self.req.b = b\r\n        self.future = self.cli.call_async(self.req)\r\n        rclpy.spin_until_future_complete(self, self.future)\r\n        return self.future.result()\n"})}),"\n",(0,i.jsx)(r.h2,{id:"parameters",children:"Parameters"}),"\n",(0,i.jsx)(r.p,{children:"ROS 2 allows nodes to have configurable parameters that can be changed at runtime:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\n\r\nclass ParameterNode(Node):\r\n    def __init__(self):\r\n        super().__init__('parameter_node')\r\n        \r\n        # Declare parameters with default values\r\n        self.declare_parameter('frequency', 1.0)\r\n        self.declare_parameter('robot_name', 'my_robot')\r\n        self.declare_parameter('sensor_enabled', True)\r\n        \r\n        # Get parameter values\r\n        frequency = self.get_parameter('frequency').value\r\n        robot_name = self.get_parameter('robot_name').value\r\n        sensor_enabled = self.get_parameter('sensor_enabled').value\r\n        \r\n        self.get_logger().info(f'Frequency: {frequency}, Robot: {robot_name}, Sensor: {sensor_enabled}')\r\n        \r\n        # Set callback for parameter changes\r\n        self.add_on_set_parameters_callback(self.parameters_callback)\r\n    \r\n    def parameters_callback(self, params):\r\n        for param in params:\r\n            if param.name == 'frequency' and param.type_ == Parameter.Type.DOUBLE:\r\n                self.get_logger().info(f'Frequency changed to: {param.value}')\r\n        return SetParametersResult(successful=True)\n"})}),"\n",(0,i.jsx)(r.h2,{id:"advanced-rclpy-concepts",children:"Advanced rclpy Concepts"}),"\n",(0,i.jsx)(r.h3,{id:"timers",children:"Timers"}),"\n",(0,i.jsx)(r.p,{children:"Timers are used to execute callbacks at regular intervals:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\n\r\nclass TimerNode(Node):\r\n    def __init__(self):\r\n        super().__init__('timer_node')\r\n        \r\n        # Create a timer that calls the callback every 500ms\r\n        self.timer = self.create_timer(0.5, self.timer_callback)\r\n        self.counter = 0\r\n\r\n    def timer_callback(self):\r\n        self.get_logger().info(f'Timer callback executed: {self.counter}')\r\n        self.counter += 1\n"})}),"\n",(0,i.jsx)(r.h3,{id:"clock-and-time",children:"Clock and Time"}),"\n",(0,i.jsx)(r.p,{children:"ROS 2 provides sophisticated time management capabilities:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom rclpy.time import Time\r\nfrom builtin_interfaces.msg import Time as TimeMsg\r\n\r\nclass TimeNode(Node):\r\n    def __init__(self):\r\n        super().__init__('time_node')\r\n        \r\n        # Get current ROS time\r\n        current_time = self.get_clock().now()\r\n        self.get_logger().info(f'Current ROS time: {current_time}')\r\n        \r\n        # Create a timer with a specific time period\r\n        self.timer = self.create_timer(1.0, self.time_callback)\r\n    \r\n    def time_callback(self):\r\n        # Get time since node started\r\n        time_since_start = self.get_clock().now().nanoseconds / 1e9\r\n        self.get_logger().info(f'Seconds since start: {time_since_start:.2f}')\n"})}),"\n",(0,i.jsx)(r.h3,{id:"waitables",children:"Waitables"}),"\n",(0,i.jsx)(r.p,{children:"Waitables allow custom synchronization mechanisms:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom rclpy.executors import Future\r\n\r\nclass WaitableNode(Node):\r\n    def __init__(self):\r\n        super().__init__('waitable_node')\r\n        \r\n        # Create a future that will be completed later\r\n        self.future = Future()\r\n        \r\n        # Add future to the executor\r\n        self.add_waitable(self.future)\r\n        \r\n        # Schedule completion of the future\r\n        self.create_timer(2.0, self.complete_future)\r\n    \r\n    def complete_future(self):\r\n        self.future.set_result('Future completed!')\r\n        self.get_logger().info('Future has been completed')\n"})}),"\n",(0,i.jsx)(r.h2,{id:"lifecycle-nodes",children:"Lifecycle Nodes"}),"\n",(0,i.jsx)(r.p,{children:"For more robust systems, especially in humanoid robotics, lifecycle nodes provide better state management:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\nfrom rclpy.lifecycle import LifecycleNode, TransitionCallbackReturn\r\nfrom rclpy.lifecycle import LifecycleState\r\n\r\nclass LifecycleExampleNode(LifecycleNode):\r\n    def __init__(self):\r\n        super().__init__('lifecycle_example_node')\r\n        self.get_logger().info('Lifecycle node created')\r\n\r\n    def on_configure(self, state: LifecycleState) -> TransitionCallbackReturn:\r\n        self.get_logger().info('Configuring node')\r\n        # Initialize resources here\r\n        return TransitionCallbackReturn.SUCCESS\r\n\r\n    def on_activate(self, state: LifecycleState) -> TransitionCallbackReturn:\r\n        self.get_logger().info('Activating node')\r\n        # Activate components here\r\n        return TransitionCallbackReturn.SUCCESS\r\n\r\n    def on_deactivate(self, state: LifecycleState) -> TransitionCallbackReturn:\r\n        self.get_logger().info('Deactivating node')\r\n        # Deactivate components here\r\n        return TransitionCallbackReturn.SUCCESS\r\n\r\n    def on_cleanup(self, state: LifecycleState) -> TransitionCallbackReturn:\r\n        self.get_logger().info('Cleaning up node')\r\n        # Clean up resources here\r\n        return TransitionCallbackReturn.SUCCESS\n"})}),"\n",(0,i.jsx)(r.h2,{id:"message-and-service-customization",children:"Message and Service Customization"}),"\n",(0,i.jsx)(r.h3,{id:"creating-custom-messages",children:"Creating Custom Messages"}),"\n",(0,i.jsxs)(r.p,{children:["To create custom messages, define them in a ",(0,i.jsx)(r.code,{children:".msg"})," file:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"# In msg/JointState.msg\r\nstring name\r\nfloat64 position\r\nfloat64 velocity\r\nfloat64 effort\n"})}),"\n",(0,i.jsx)(r.p,{children:"Then use them in Python:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"from my_robot_msgs.msg import JointState\r\n\r\nclass JointStatePublisher(Node):\r\n    def __init__(self):\r\n        super().__init__('joint_state_publisher')\r\n        self.publisher = self.create_publisher(JointState, 'joint_states', 10)\r\n    \r\n    def publish_joint_state(self, name, pos, vel, effort):\r\n        msg = JointState()\r\n        msg.name = name\r\n        msg.position = pos\r\n        msg.velocity = vel\r\n        msg.effort = effort\r\n        self.publisher.publish(msg)\n"})}),"\n",(0,i.jsx)(r.h3,{id:"custom-services",children:"Custom Services"}),"\n",(0,i.jsxs)(r.p,{children:["Define services in ",(0,i.jsx)(r.code,{children:".srv"})," files:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"# In srv/MoveJoint.srv\r\nstring joint_name\r\nfloat64 target_position\r\n---\r\nbool success\r\nstring message\n"})}),"\n",(0,i.jsx)(r.p,{children:"Use them in Python:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"from my_robot_msgs.srv import MoveJoint\r\n\r\nclass JointController(Node):\r\n    def __init__(self):\r\n        super().__init__('joint_controller')\r\n        self.srv = self.create_service(MoveJoint, 'move_joint', self.move_joint_callback)\r\n    \r\n    def move_joint_callback(self, request, response):\r\n        # Perform joint movement\r\n        success = self.move_single_joint(request.joint_name, request.target_position)\r\n        \r\n        response.success = success\r\n        if success:\r\n            response.message = f'Successfully moved {request.joint_name} to {request.target_position}'\r\n        else:\r\n            response.message = f'Failed to move {request.joint_name}'\r\n        \r\n        return response\n"})}),"\n",(0,i.jsx)(r.h2,{id:"threading-and-concurrency",children:"Threading and Concurrency"}),"\n",(0,i.jsx)(r.p,{children:"rclpy provides several execution models for handling concurrency:"}),"\n",(0,i.jsx)(r.h3,{id:"single-threaded-executor",children:"Single-threaded Executor"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.executors import SingleThreadedExecutor\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    \r\n    node1 = MinimalPublisher()\r\n    node2 = MinimalSubscriber()\r\n    \r\n    executor = SingleThreadedExecutor()\r\n    executor.add_node(node1)\r\n    executor.add_node(node2)\r\n    \r\n    try:\r\n        executor.spin()\r\n    finally:\r\n        executor.shutdown()\r\n        node1.destroy_node()\r\n        node2.destroy_node()\r\n        rclpy.shutdown()\n"})}),"\n",(0,i.jsx)(r.h3,{id:"multi-threaded-executor",children:"Multi-threaded Executor"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.executors import MultiThreadedExecutor\r\n\r\ndef main(args=None):\r\n    rclpy.init(args=args)\r\n    \r\n    node1 = MinimalPublisher()\r\n    node2 = MinimalSubscriber()\r\n    \r\n    executor = MultiThreadedExecutor(num_threads=4)\r\n    executor.add_node(node1)\r\n    executor.add_node(node2)\r\n    \r\n    try:\r\n        executor.spin()\r\n    finally:\r\n        executor.shutdown()\r\n        node1.destroy_node()\r\n        node2.destroy_node()\r\n        rclpy.shutdown()\n"})}),"\n",(0,i.jsx)(r.h2,{id:"error-handling-and-best-practices",children:"Error Handling and Best Practices"}),"\n",(0,i.jsx)(r.h3,{id:"exception-handling",children:"Exception Handling"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom rclpy.node import Node\r\n\r\nclass RobustNode(Node):\r\n    def __init__(self):\r\n        super().__init__('robust_node')\r\n        try:\r\n            self.setup_components()\r\n        except Exception as e:\r\n            self.get_logger().error(f'Failed to initialize: {e}')\r\n            raise\r\n    \r\n    def setup_components(self):\r\n        # Setup code that might fail\r\n        pass\r\n    \r\n    def safe_publish(self, publisher, msg):\r\n        try:\r\n            publisher.publish(msg)\r\n        except Exception as e:\r\n            self.get_logger().error(f'Failed to publish message: {e}')\n"})}),"\n",(0,i.jsx)(r.h3,{id:"resource-management",children:"Resource Management"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'import rclpy\r\nfrom rclpy.node import Node\r\n\r\nclass ResourceManagedNode(Node):\r\n    def __init__(self):\r\n        super().__init__(\'resource_managed_node\')\r\n        \r\n        # Initialize resources\r\n        self.publisher = self.create_publisher(String, \'topic\', 10)\r\n        self.timer = self.create_timer(1.0, self.timer_callback)\r\n        \r\n        # Register cleanup function\r\n        import atexit\r\n        atexit.register(self.cleanup)\r\n    \r\n    def cleanup(self):\r\n        """Cleanup function to release resources"""\r\n        self.get_logger().info(\'Cleaning up resources...\')\r\n        # Close files, disconnect from hardware, etc.\r\n    \r\n    def destroy_node(self):\r\n        """Override to ensure cleanup"""\r\n        self.cleanup()\r\n        super().destroy_node()\n'})}),"\n",(0,i.jsx)(r.h2,{id:"python-specific-considerations",children:"Python-Specific Considerations"}),"\n",(0,i.jsx)(r.h3,{id:"memory-management",children:"Memory Management"}),"\n",(0,i.jsx)(r.p,{children:"When working with large data (like images or point clouds), be mindful of memory usage:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"import rclpy\r\nfrom sensor_msgs.msg import Image\r\nimport numpy as np\r\n\r\nclass ImageProcessor(Node):\r\n    def __init__(self):\r\n        super().__init__('image_processor')\r\n        self.subscription = self.create_subscription(\r\n            Image, 'camera/image_raw', self.image_callback, 10)\r\n        \r\n    def image_callback(self, msg):\r\n        # Convert image without unnecessary copying\r\n        img = np.frombuffer(msg.data, dtype=np.uint8).reshape(msg.height, msg.width, -1)\r\n        \r\n        # Process image\r\n        processed_img = self.process_image(img)\r\n        \r\n        # Ensure we don't hold references to large data longer than necessary\r\n        del img  # Explicitly delete if needed\n"})}),"\n",(0,i.jsx)(r.h3,{id:"type-hints-for-better-code",children:"Type Hints for Better Code"}),"\n",(0,i.jsx)(r.p,{children:"Using type hints improves code readability and helps with debugging:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"from typing import Optional\r\nimport rclpy\r\nfrom rclpy.node import Node\r\nfrom std_msgs.msg import String\r\nfrom rclpy.timer import Timer\r\nfrom rclpy.qos import QoSProfile\r\n\r\nclass TypedNode(Node):\r\n    def __init__(self):\r\n        super().__init__('typed_node')\r\n        self.publisher: Optional[rclpy.publisher.Publisher] = None\r\n        self.timer: Optional[Timer] = None\r\n        self.qos_profile: QoSProfile = QoSProfile(depth=10)\r\n        \r\n        self.setup_components()\r\n    \r\n    def setup_components(self) -> None:\r\n        self.publisher = self.create_publisher(String, 'topic', self.qos_profile)\r\n        self.timer = self.create_timer(0.5, self.timer_callback)\r\n    \r\n    def timer_callback(self) -> None:\r\n        if self.publisher:\r\n            msg = String()\r\n            msg.data = 'Hello with types!'\r\n            self.publisher.publish(msg)\n"})}),"\n",(0,i.jsx)(r.p,{children:"The rclpy library provides a powerful and Pythonic way to develop ROS 2 applications. Its integration with Python's ecosystem allows for rapid development and prototyping, which is particularly valuable in the complex domain of humanoid robotics where rapid iteration is often necessary."})]})}function p(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,r,n){n.d(r,{R:()=>l,x:()=>o});var s=n(6540);const i={},t=s.createContext(i);function l(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(t.Provider,{value:r},e.children)}}}]);